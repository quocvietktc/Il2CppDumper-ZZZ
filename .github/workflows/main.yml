name: Build NativeAOT Android

on: [push, workflow_dispatch]

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. Cài đặt trình giả lập QEMU (Để chạy được môi trường chip điện thoại trên Server)
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    # 2. Build bên trong Docker Container (Môi trường ARM64 chuẩn của Microsoft)
    - name: Build inside Docker
      run: |
        # Chạy container .NET 9 trên nền tảng linux/arm64
        docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
        
        docker run --rm --platform linux/arm64 \
        -v ${{ github.workspace }}:/src \
        -w /src/Il2CppDumper \
        mcr.microsoft.com/dotnet/sdk:9.0-bookworm-arm64v8 \
        /bin/bash -c "
            echo '--- Installing Dependencies ---' && \
            apt-get update && \
            apt-get install -y clang zlib1g-dev && \
            
            echo '--- Building Native AOT ---' && \
            dotnet publish -c Release -r linux-arm64 -f net9.0 -o /src/output
        "

    # 3. Tải file kết quả về
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dumper
        path: output/Il2CppDumper
